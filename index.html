<!DOCTYPE html>
<html>
<head>
    <title>BLOCKS is traditional block puzzle game</title>
    <script src="https://unpkg.com/vue"></script>
    <meta name="viewport" content="width=device-width">
    <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
</head>
<body>
    <div id="app">
      <div class="pause" v-if="isPause">
        <button onClick="doAction();">{{stlabel}}</button>
      </div>
      <section class="view">
        <div class="wrapper">
          <div class="field" v-html="fieldBlocks">
          </div>
          <div class="next" v-html="nextBlock">
          </div>
          <div class="data">
            <h1>SCORE</h1>
            <p>{{valScore}}</p>
            <hr>
            <h1>TIME</h1>
            <p>{{strTime}}</p>
          </div>
        </div>
      </section>
      <section class="control">
        <div class="control-part cursor">
          <button class="cursorL"><i class="fas fa-angle-left"></i></button>
          <button class="cursorR"><i class="fas fa-angle-right"></i></button>
        </div>
        <div class="control-part hoge">
          <button class="btnPause" onClick="doPause();">Pause</button>
        </div>
        <div class="control-part rotate">
          <button class="rotateL"><i class="fas fa-undo"></i></button>
          <button class="rotateR"><i class="fas fa-redo"></i></button>
        </div>
      </section>
    </div>
    <script>
        var data = {
          numWidth: 10,
          numHeight: 20,
          blocks: [
            [[0,0,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],
            [[0,0,0,0,0],[0,1,1,0,0],[0,1,1,0,0],[0,0,0,0,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,1,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,0,1,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0],[0,1,0,0,0],[0,0,0,0,0]]
          ],
          coordinate: [0,3],
          stack: [
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],//view
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0]
          ],
          field: [],
        　trgNext: true,
          next: parseInt(Math.random() * 7) + 1,
          current: 0,
          isPause: true,
          stlabel: 'スタート',
          fieldBlocks: '',
          nextBlock: '',
          valScore: 0,
          countTime: 0,
          strTime: '0:00:00',
        };
        var app = new Vue({
          el: '#app',
          data: data,
        });
        window.onload = onload();
        function onload() {
            var valInit = [0,3];
            var num;
            var flgStep;
            var dig = ['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f','g','h','i','j'];
            setInterval(function(){
                if(!data.isPause){
                    //Time Count
                    data.countTime ++;
                    ss = data.countTime % 60;
                    mm = ((data.countTime - ss) / 60) % 60;
                    h = (data.countTime - (mm * 60) - ss) / 3600 ;
                    data.strTime = h + ':' + ('0' + mm).slice(-2) + ':' + ('0' + ss).slice(-2);
                    //Next Block
                    if(data.trgNext){
                        data.current = data.next;
                        data.coordinate = valInit;
                        data.next = parseInt(Math.random() * 7) + 1;
                        data.nextBlock = '';
                        for(i = 0; i < 5; i++){
                            for(j = 0; j < 5; j++){
                                num = data.blocks[data.next][i][j];
                                data.nextBlock += '<div class="dspgrid gr-' + i + '' + j + '';
                                if(num == 0){
                                    data.nextBlock += '"></div>';
                                }else{
                                    data.nextBlock += ' bl-' + data.next + '"></div>';
                                }
                            }
                        }
                        data.trgNext = false;
                    }
                    //Field & Current Block
                    if(!data.trgNext){
                        flgStep = true;
                        data.field = data.stack;
                        for(i = 0; i < 5; i++){
                            if(!flgStep){break;}
                            for(j = 0; j < 5; j++){
                                num = data.blocks[data.current][i][j];
                                if(num > 0){
                                    if(data.stack[data.coordinate[0] + i + 1][data.coordinate[1] + j] != 0){
                                        flgStep = false;
                                        break;
                                    }
                                }
                            }
                        }
                        if(flgStep){
                          data.coordinate[0] ++;
                        }
                        for(i = 0; i < 5; i++){
                            for(j = 0; j < 5; j++){
                                num = data.blocks[data.current][i][j];
                                    if(num != 0){
                                    data.field[data.coordinate[0] + i][data.coordinate[1] +j] = num;
                                }
                            }
                        }
                        if(!flgStep){
                            data.stack = data.field;
                            data.trgNext = true;
                        }
                        data.fieldBlocks = ''
                        for(i = 5; i < 25; i++){
                            for(j = 0; j < 10; j++){
                                num = data.field[i][j];
                                if(num == 0){
                                    data.fieldBlocks += '<div class="dspgrid gr-' + dig[i - 5] + dig[j] + '"></div>'
                                }else{
                                    data.fieldBlocks += '<div class="dspgrid gr-' + dig[i - 5] + dig[j] + ' bl-' + data.current + '"></div>'
                                }
                            }
                        }
                    }
                }
            }, 1000);
        };
        function doAction() {
          data.isPause = false;
          data.stlabel = '再開';
          console.log('start');
        };
        function doPause() {
          data.isPause = true;
          console.log('pause');
        };
    </script>
</body>
</html>