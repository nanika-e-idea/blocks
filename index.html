<!DOCTYPE html>
<html>
<head>
    <title>BLOCKS is traditional block puzzle game</title>
    <script src="https://unpkg.com/vue"></script>
    <meta name="viewport" content="width=device-width">
    <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
</head>
<body>
    <div id="app">
      <div class="pause" v-if="isPause">
        <button v-if="isContinue" onClick="doAction();">{{stlabel}}</button>
        <template v-else>
        <h1>   残念...</h1>
        <button onClick="doRestart();">もう一度</button>
        </template>
      </div>
      <section class="view">
        <div class="wrapper">
          <div class="field" v-html="fieldBlocks">
          </div>
          <div class="next" v-html="nextBlock">
          </div>
          <div class="data">
            <h1>SCORE</h1>
            <p>{{valScore}}</p>
            <hr>
            <h1>TIME</h1>
            <p>{{strTime}}</p>
          </div>
        </div>
      </section>
      <section class="control">
        <div class="control-part cursor">
          <button class="cursorL" onClick="doMoveL();"><i class="fas fa-angle-left"></i></button>
          <button class="cursorR" onClick="doMoveR();"><i class="fas fa-angle-right"></i></button>
        </div>
        <div class="control-part hoge">
          <button class="btnPause" onClick="doPause();">Pause</button>
        </div>
        <div class="control-part rotate">
          <button class="rotateL"><i class="fas fa-undo"></i></button>
          <button class="rotateR"><i class="fas fa-redo"></i></button>
        </div>
      </section>
    </div>
    <script>
        var data = {
          numWidth: 10,
          numHeight: 20,
          blocks: [
            [[0,0,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],
            [[0,0,0,0,0],[0,2,2,0,0],[0,2,2,0,0],[0,0,0,0,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,3,0,0],[0,3,3,3,0],[0,0,0,0,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,4,0,0],[0,0,4,0,0],[0,0,4,4,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,5,0,0],[0,0,5,0,0],[0,5,5,0,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,6,0,0],[0,0,6,6,0],[0,0,0,6,0],[0,0,0,0,0]],
            [[0,0,0,0,0],[0,0,7,0,0],[0,7,7,0,0],[0,7,0,0,0],[0,0,0,0,0]]
          ],
          initCoord : [0,3],
          coordinate: [],
          initStack: [
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],//view
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0],
              [0,0,0,0,0,0,0,0,0,0]
          ],
          stack:[],
          field: [],
          trgNext: true,
          next: parseInt(Math.random() * 7),
          current: 0,
          isPause: true,
          stlabel: 'スタート',
          fieldBlocks: '',
          nextBlock: '',
          valScore: 0,
          countTime: 0,
          strTime: '0:00:00',
          isLanding: false,
          isContinue: true,
          isControl: false,
          isMovable: true,
        };
        var app = new Vue({
          el: '#app',
          data: data,
        });
        window.onload = fnOnload();
        function fnOnload() {
          var num = 0;
          setInterval(function(){
            if(!data.isPause){
              //Time Count
              data.countTime ++;
              ss = data.countTime % 60;
              mm = ((data.countTime - ss) / 60) % 60;
              h = (data.countTime - (mm * 60) - ss) / 3600 ;
              data.strTime = h + ':' + ('0' + mm).slice(-2) + ':' + ('0' + ss).slice(-2);
              //- Time Count
              //Next Block
              if(data.trgNext){
                data.current = data.next;
                data.coordinate = JSON.parse(JSON.stringify(data.initCoord));
                data.next = parseInt(Math.random() * 7);
                data.nextBlock = '';
                for(i = 0; i < 5; i++){
                  for(j = 0; j < 5; j++){
                    num = data.blocks[data.next][i][j];
                    data.nextBlock += '<div class="dspgrid gr-' + i + '' + j + '';
                    if(num == 0){
                      data.nextBlock += '"></div>';
                    }else{
                      data.nextBlock += ' bl-' + (data.next + 1) + '"></div>';
                    }
                  }
                }
                data.trgNext = false;
              }
              //- Next Block
              //Field & Current Block
              ////field initialize
              if(!data.stack[0]){
                data.stack = JSON.parse(JSON.stringify(data.initStack));
              }
              if(!data.isControl){
                ////gadge landing
                for(i = 0; i < 5; i++){
                  if(data.isLanding){break;}
                    for(j = 0; j < 5; j++){
                      num = data.blocks[data.current][i][j];
                      if(num != 0){
                        if(data.coordinate[0] + i < 24){
                          if(data.stack[(data.coordinate[0] + i + 1)][(data.coordinate[1] + j)] != 0){
                            data.isLanding = true;
                            console.log('bump!' + (data.coordinate[0] + i + 1) + ':' + (data.coordinate[1] + j) + ' is ' + data.stack[(data.coordinate[0] + i + 1)][(data.coordinate[1] + j)]);
                            break;
                          }
                        }else{
                          data.isLanding = true;
                          console.log('Max depth!');
                          break;
                        }
                      }
                    }
                }
                if(!data.isLanding){
                  data.coordinate[0] ++;
                  console.log('drop');
                  console.log(data.coordinate);
                }
                ////draw field blocks
                drawField();
                  ////jadge erase line and game is over
                if(data.isLanding){
                  var valTmp = data.field[3].reduce(function (accumulator, currentValue, currentIndex, array) {
                    return accumulator + currentValue;
                  });
                  if(valTmp > 0){
                    data.isPause = true;
                    data.isContinue = false;
                    console.log('GAME is OVER');
                  }else{
                    data.stack = JSON.parse(JSON.stringify(data.field));
                    eraseLine();
                    data.isLanding = false;
                    data.trgNext = true;
                  }
                }
              }
              //- Field & Current Block
            }
          }, 1000);
        };
        function doAction() {
          data.isPause = false;
          data.stlabel = '再開';
          console.log('continue');
        };
        function doPause() {
          data.isPause = true;
          console.log('pause');
        };
        function doRestart() {
          data.stack = [];
          data.field = [];
          data.valScore = 0;
          data.countTime = 0;
          data.isLanding = false;
          data.trgNext = true;
          data.isContinue = true;
          data.isPause = false;
          data.next = parseInt(Math.random() * 7);
          data.current = 0;
          console.log('restart');
        };
        function drawField(){
          var dig = ['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f','g','h','i','j'];
          data.field = JSON.parse(JSON.stringify(data.stack));
          for(m = 0; m < 5; m++){
            for(n = 0; n < 5; n++){
              num = data.blocks[data.current][m][n];
              if(num != 0 && (data.coordinate[0] + m) < 25 && data.coordinate[1] + n >= 0 && data.coordinate[1] + n < 10){
                data.field[data.coordinate[0] + m][data.coordinate[1] + n] = num;
              }
            }
          }
          var strTmp = '';
          data.fieldBlocks = '';
          for(m = 5; m < 25; m++){
            if(m > 0){strTmp += '\n';}
            for(n = 0; n < 10; n++){
              num = data.field[m][n];
              strTmp += '' + num; 
              if(num == 0){
                data.fieldBlocks += '<div class="dspgrid gr-' + dig[m - 5] + dig[n] + '"></div>';
              }else{
                data.fieldBlocks += '<div class="dspgrid gr-' + dig[m - 5] + dig[n] + ' bl-' + (data.field[m][n]) + '"></div>';
              }
            }
          }
          console.log(strTmp);
        };
        function eraseLine(){
          var eraseList = [];
          var strCK = '';
          for(i = 24; i >= 0; i--){
            if(Math.min.apply(null, data.stack[i]) > 0){
              eraseList[i] = 1;
              //strCK += '1';
            }else{
              eraseList[i] = 0;
              //strCK += '0';
            }
              strCK += ' ' + Math.min.apply(null, data.stack[i]);
          }
          console.log(strCK);
          k = 0;
          for(i = 24; i >= 0; i--){
            if(eraseList[i] == 1){
              for(j = 0; j < 5; j++){
                if(eraseList[i - j] == 1){
                  k++;
                }
              }
            }
            if(k > i){
              data.stack[i] = [0,0,0,0,0,0,0,0,0,0];
              console.log('fill space');
            }else{
              data.stack[i] = JSON.parse(JSON.stringify(data.stack[i - k]));
              console.log('erase line');
            }
          }
        };
        function doMoveL() {
          data.isControl = true;
          for(k = 0; k < 5; k++){
            if(!data.isMovable){break;}
            for(l = 0; l < 5; l++){
              num = data.blocks[data.current][k][l];
                if(num != 0){
                  if(data.coordinate[1] + l > 0){
                    if(data.stack[(data.coordinate[0] + k)][(data.coordinate[1] + l - 1)] !== 0){
                      data.isMovable = false;
                      console.log('bump!' + (data.coordinate[0] + k) + ':' + (data.coordinate[1] + l - 1) + ' is ' + data.stack[(data.coordinate[0] + k)][(data.coordinate[1] + l - 1)]);
                      break;
                    }
                  }else{
                    data.isMovable = false;
                    console.log('Left Limit!');
                    break;
                  }
                }
            }
          }
          if(data.isMovable){
            data.coordinate[1] --;
            drawField();
            console.log('Move Left');
          }
          data.isMovable = true;
          data.isControl = false;
        };
        function doMoveR() {data.isControl = true;
          for(k = 0; k < 5; k++){
            if(!data.isMovable){break;}
            for(l = 0; l < 5; l++){
              num = data.blocks[data.current][k][l];
                if(num != 0){
                  if(data.coordinate[1] + l < 9){
                    if(data.stack[(data.coordinate[0] + k)][(data.coordinate[1] + l + 1)] !== 0){
                      data.isMovable = false;
                      console.log('bump!' + (data.coordinate[0] + k) + ':' + (data.coordinate[1] + l + 1) + ' is ' + data.stack[(data.coordinate[0] + k)][(data.coordinate[1] + l + 1)]);
                      break;
                    }
                  }else{
                    data.isMovable = false;
                    console.log('Right Limit!');
                    break;
                  }
                }
            }
          }
          if(data.isMovable){
            data.coordinate[1] ++;
            drawField();
            console.log('Move Left');
          }
          data.isMovable = true;
          data.isControl = false;
        };
        function doRotateL() {
          data.isControl = true;
          data.isControl = false;
        };
        function doRotateR() {
          data.isControl = true;
          data.isControl = false;
        };
    </script>
</body>
</html>